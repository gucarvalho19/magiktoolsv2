name: Branch Protection Simulation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    # Only run on pull requests, skip on direct pushes to main/develop
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install

      - name: Check TypeScript (frontend)
        working-directory: ./frontend
        run: npx tsc --noEmit

      - name: Build frontend
        working-directory: ./frontend
        run: bunx vite build

      # Backend checks disabled - Encore requires special setup
      # Backend is validated during Encore deployment
      # - name: Install backend dependencies
      #   working-directory: ./backend
      #   run: bun install
      #
      # - name: Check TypeScript (backend)
      #   working-directory: ./backend
      #   run: npx tsc --noEmit

  pr-title-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf):"; then
            echo "‚ùå PR title must follow Conventional Commits format"
            echo ""
            echo "Format: <type>: <description>"
            echo ""
            echo "Valid types:"
            echo "  - feat:     New feature"
            echo "  - fix:      Bug fix"
            echo "  - docs:     Documentation"
            echo "  - style:    Formatting"
            echo "  - refactor: Code refactoring"
            echo "  - test:     Tests"
            echo "  - chore:    Maintenance"
            echo "  - perf:     Performance"
            echo ""
            echo "Example: 'feat: add presell builder tool'"
            exit 1
          fi

          echo "‚úÖ PR title format is valid: $PR_TITLE"

  security-check:
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Check for exposed secrets
        run: |
          echo "üîç Checking for accidentally exposed secrets..."

          BASE_REF="origin/${{ github.base_ref }}"

          # Check if base ref exists
          if ! git rev-parse --verify "$BASE_REF" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Base branch $BASE_REF not found, skipping diff check"
            exit 0
          fi

          DIFF_CMD="git diff $BASE_REF...HEAD"

          # Check for secret keys (sk_)
          if $DIFF_CMD | grep -i "sk_test\|sk_live"; then
            echo "‚ùå SECURITY: Secret key (sk_*) detected in changes!"
            echo "Clerk secret keys should NEVER be committed."
            echo "Use Encore Secrets instead: encore secret set --type dev ClerkSecretKey"
            exit 1
          fi

          # Check for common secret patterns (excluding Encore's secret() function)
          POTENTIAL_SECRETS=$($DIFF_CMD | grep -iE "password\s*=|api[_-]?key\s*=|secret\s*=" | grep -v "secret(" || true)

          if [ -n "$POTENTIAL_SECRETS" ]; then
            echo "‚ö†Ô∏è  WARNING: Potential secret detected in changes"
            echo "Please review the diff to ensure no secrets are exposed"
            echo ""
            echo "$POTENTIAL_SECRETS"
            exit 1
          fi

          echo "‚úÖ No secrets detected in changes"

  lint-check:
    runs-on: ubuntu-latest
    # Only run on pull requests
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Check for console.log
        run: |
          echo "üîç Checking for console.log statements..."

          BASE_REF="origin/${{ github.base_ref }}"

          # Check if base ref exists
          if ! git rev-parse --verify "$BASE_REF" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Base branch $BASE_REF not found, skipping diff check"
            exit 0
          fi

          DIFF_CMD="git diff $BASE_REF...HEAD"

          # Find console.log in TypeScript/JavaScript files (excluding comments)
          CONSOLE_LOGS=$($DIFF_CMD -- '*.ts' '*.tsx' '*.js' '*.jsx' | grep "^+" | grep -v "^+++" | grep "console\.log" || true)

          if [ -n "$CONSOLE_LOGS" ]; then
            echo "‚ö†Ô∏è  WARNING: console.log detected in changes"
            echo "Consider removing debug statements before merging"
            echo ""
            echo "$CONSOLE_LOGS"
            # Don't fail, just warn
          else
            echo "‚úÖ No console.log statements found"
          fi

      - name: Check for TODO comments
        run: |
          echo "üîç Checking for TODO comments in new code..."

          BASE_REF="origin/${{ github.base_ref }}"

          # Check if base ref exists
          if ! git rev-parse --verify "$BASE_REF" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Base branch $BASE_REF not found, skipping diff check"
            exit 0
          fi

          DIFF_CMD="git diff $BASE_REF...HEAD"

          TODOS=$($DIFF_CMD | grep "^+" | grep -v "^+++" | grep -iE "TODO|FIXME|XXX|HACK" || true)

          if [ -n "$TODOS" ]; then
            echo "‚ÑπÔ∏è  INFO: TODO comments found in changes"
            echo "Make sure these are intentional:"
            echo ""
            echo "$TODOS"
          else
            echo "‚úÖ No TODO comments found"
          fi
